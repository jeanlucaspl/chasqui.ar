<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1", viewport-fit="cover" />
<title>chasqui.ar ‚Äì Cat√°logo</title>

<link rel="preload" as="image" href="logo-chasqui.png">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=League+Spartan:wght@400;700;800&display=swap" rel="stylesheet">

<style>
  :root{

    
    /* Tema base */
    --white:#ffffff; --ink:#121212; --muted-ink:#60646c;

    /* Paleta chicha/chasqui */
    --p1:#ff006e; --p2:#ffd166; --p3:#06d6a0; --p4:#00d6ff; --p5:#3a86ff; --p6:#8338ec; --p7:#fb5607;

    /* Header */
    --header-h: 20vh;
    --header-col-logo: 12%;
    --header-col-search: 64%;
    --header-col-offers: 12%;
    --header-col-cart: 12%;
    --logo-header-maxh: calc(var(--header-h) * 0.8);
    --search-h:          calc(var(--header-h) * 0.5);
    --icon-btn-size:     calc(var(--header-h) * 0.5);
    --icon-font:         clamp(10px, calc(var(--header-h)*0.16), 12px);

    /* Varios */
    --shadow-base: 0 2px 14px rgba(0,0,0,.06);
    --cart-drawer-w: 30vw;
    --wa-size-desktop: 12vmin;
    --wa-size-mobile:  16vmin;
    --zoom-press: 1.08;
    --zoom-hover: 1.05;
    --grid-safe-pad: 24px;

    /* Splash */
    --logoSize: 20vmin;
    --videoSize: 30vmin;
    --loaderMs: 2s;
    --ar-celeste-1:#00d6ff; --ar-celeste-2:#38e8ff; --ar-celeste-3:#9af3ff;

    --edge-pad: 16px;          /* separaci√≥n m√≠nima del borde */
    --wa-size-desktop: 12vmin; /* puedes cambiarlo por 72px, etc. */
    --wa-size-mobile:  16vmin;
  }
  #home{ background: transparent !important; }
  .page{ background: transparent; }          /* por defecto, transparente */
  .page:not(#home){ background:#fff; }       /* subp√°ginas blancas */
   main.wrap{ background: transparent !important; }



  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:var(--white); color:var(--ink);
    font:16px/1.45 "League Spartan", system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, "Helvetica Neue", Arial;
  }
  a{color:inherit; text-decoration:none}

  /* SPLASH (opcional) */
  #splash{
    position:fixed; inset:0; display:flex; flex-direction:column; gap:18px;
    align-items:center; justify-content:center; background:var(--white);
    z-index:9999; padding:24px; opacity:1; visibility:visible;
    transition: opacity .35s ease, visibility .35s ease;
  }
  #splash.is-hidden{ opacity:0; visibility:hidden; }
  .splash-logo{ width:var(--logoSize); }
  .splash-logo img{ width:100%; height:auto; display:block; }
  .splash-video{ width:var(--videoSize); height:var(--videoSize); display:grid; place-items:center; overflow:hidden; border-radius:12px; background:#fff; }
  .splash-video video{ width:100%; height:100%; display:block; object-fit:cover; background:#fff; }
  .loader{ position:relative; width:min(560px, 25vw); height:6px; border-radius:999px; background:#eef1f4; overflow:hidden; }
  .loader::after{
    content:""; position:absolute; inset:0; transform:scaleX(0); transform-origin:left;
    background: linear-gradient(90deg, var(--ar-celeste-1) 0%, var(--ar-celeste-2) 50%, var(--ar-celeste-3) 100%);
    animation: fill var(--loaderMs, 2s) ease forwards;
  }
  @keyframes fill{ to{ transform:scaleX(1);} }

  /* HEADER */
  header{
    position:sticky; top:0; z-index:10; background:var(--white);
    box-shadow:none; border-bottom:1px solid #eceff3;
  }
  .wrap{max-width:1100px; margin:0 auto; padding:20px;}
  .wrap.headerBar{padding:20px;}
  .headerBar{
    display:grid;
    grid-template-columns: var(--header-col-logo) var(--header-col-search) var(--header-col-offers) var(--header-col-cart);
    grid-template-areas: "logo search offers cart";
    align-items:center; column-gap:14px; height: var(--header-h);
  }
  .logoWrap{grid-area:logo; display:flex; align-items:center; cursor:pointer; height:100%}
  .logoWrap img{width:100%; height:auto; max-height: var(--logo-header-maxh); object-fit:contain}

  .search{
    grid-area:search; display:flex; align-items:center; gap:10px;
    height:var(--search-h); background:#f7f9fc;
    border:1px solid #e6ebf2; border-radius:12px; padding:0 12px; position:relative;
  }
  .search input{flex:1; background:transparent; border:0; outline:none; color:var(--ink); font-size: clamp(14px, 2.2vmin, 18px)}

  .iconBlock{display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%}
  .iconBlock.offers{grid-area:offers}
  .iconBlock.cart{grid-area:cart}
  .iconBtn{position:relative; width:var(--icon-btn-size); height:var(--icon-btn-size); border:0; background:transparent; border-radius:12px; cursor:pointer; display:grid; place-items:center}
  .iconLabel{margin-top:4px; font-weight:700; font-size: var(--icon-font); color:var(--muted-ink); line-height:1}

  .pressable{transition:transform .12s ease, filter .12s ease; touch-action:manipulation; user-select:none; will-change:transform}
  .pressable:hover{transform:scale(var(--zoom-hover))}
  .pressable.is-pressing{transform:scale(var(--zoom-press))}

  .badge{
    position:absolute; top:-6px; right:-6px; background:#dfff4f; color:#103426;
    min-width:20px; height:20px; border-radius:999px; font-weight:800; font-size:12px;
    display:flex; align-items:center; justify-content:center; padding:0 6px;
    box-shadow: var(--shadow-base);
  }

  /* M√≥viles */
  @media (max-width: 680px){
    .wrap.headerBar{ max-width:none; width:100%; padding:10px 12px; height:auto; }
    .logoWrap{ display:none; }
    .headerBar{
      grid-template-columns: 1fr 1fr;
      grid-template-areas:
        "search search"
        "offers cart";
      row-gap: 8px; justify-items: center;
    }
    .search{width:100%; height: calc(var(--header-h) * 0.3); margin:0;}
    .iconBtn{width: calc(var(--header-h) * 0.55); height: calc(var(--header-h) * 0.4)}
    .iconLabel{font-size: clamp(10px, calc(var(--header-h)*0.20), 12px)}
    :root{ --cart-drawer-w: 80vw; }
  }

  /* Capa de QUIPUS: full-width (fixed) por debajo del header */
  #quipu-sky{
    position:fixed; left:0; right:0; top:var(--sky-top, 0px); bottom:0;
    pointer-events:none; z-index:0; overflow:hidden;
  }

  /* Vista/Pages */
  main.wrap{ position:relative; background:transparent; z-index:1; }
  #view{ position:relative; min-height:50vh; z-index:1; overflow:visible; }

  /* P√°ginas animadas (slide) */
  .page{
    position:absolute; inset:0; background:#fff; z-index:2;
    transform:translateX(100%); opacity:0;
    transition: transform .35s cubic-bezier(.22,.61,.36,1), opacity .35s;
    touch-action: pan-y; overflow:visible;
  }
  .page.active{ transform:translateX(0); opacity:1 }
  .page.exit-right{ transform:translateX(100%); opacity:0 }

  /* HOME (grid de categor√≠as como botones) */
  .homeGrid{
    display:grid; grid-template-columns: repeat(3, 1fr); gap:16px;
    padding: var(--grid-safe-pad);
  }
  .tile{
    --tile-color: var(--p1);
    display:flex; align-items:center; justify-content:center; text-align:center;
    background:#fff; border:2px solid var(--tile-color);
    color:var(--tile-color); font-weight:800; border-radius:16px;
    height:18vmin; min-height:100px; padding:12px;
    transition:transform .15s ease, box-shadow .15s ease, border-color .15s ease, color .15s ease;
    box-shadow: var(--shadow-base);
  }
  .tile:hover{ transform:translateY(-2px) scale(var(--zoom-hover)); }
  .tile small{ display:block; margin-top:6px; font-weight:700; color:var(--muted-ink); }

  /* Colores c√≠clicos */
  .homeGrid .tile:nth-child(6n+1){ --tile-color: var(--p1); }
  .homeGrid .tile:nth-child(6n+2){ --tile-color: var(--p2); }
  .homeGrid .tile:nth-child(6n+3){ --tile-color: var(--p3); }
  .homeGrid .tile:nth-child(6n+4){ --tile-color: var(--p4); }
  .homeGrid .tile:nth-child(6n+5){ --tile-color: var(--p5); }
  .homeGrid .tile:nth-child(6n+6){ --tile-color: var(--p7); }

  @media (max-width: 920px){ .homeGrid{grid-template-columns: repeat(2, 1fr);} }
  @media (max-width: 520px){ .homeGrid{grid-template-columns: 1fr;} }

  /* Cat√°logo */
  .titleBar{display:flex; align-items:center; justify-content:space-between; margin:12px 0 16px}
  .titleBar h2{margin:0; font-size: clamp(18px, 3.2vmin, 24px); color:var(--p4)}
  .backBtn{display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:10px; border:1px solid #e6ebf2; color:var(--ink)}
  .grid{display:grid; grid-template-columns: repeat( auto-fill, minmax(220px, 1fr)); gap:14px; overflow:visible}
  .card{background:#fff; border:1px solid #e6ebf2; border-radius:16px; overflow:hidden; display:flex; flex-direction:column; box-shadow:var(--shadow-base)}
  .ph{height:160px; display:flex; align-items:center; justify-content:center; background:#f7f9fc}
  .ph img{width:100%; height:100%; object-fit:contain;}
  .info{padding:12px 14px; display:grid; gap:6px}
  .title{font-weight:800}
  .meta{display:flex; gap:8px; align-items:center; justify-content:space-between; color:var(--muted-ink); font-size:13px}
  .qtyRow{display:flex; gap:10px; align-items:center; justify-content:space-between; padding:0 14px 14px}
  .qtyCtrl{display:flex; align-items:center; gap:10px}
  .btnIcon{width:36px; height:36px; display:inline-flex; align-items:center; justify-content:center; border-radius:10px; background:transparent; color:var(--ink); border:1px solid #e0e6ef; font-weight:800; font-size:18px; cursor:pointer}
  .btnPrimary{flex:1; display:inline-flex; align-items:center; justify-content:center; padding:10px 12px; border-radius:12px; border:1px solid #ffd166; background:#ffd166; color:#0c1a0f; font-weight:800; cursor:pointer}

  /* Drawer Carrito */
  .drawerOverlay{position:fixed; inset:0; background:rgba(0,0,0,.25); opacity:0; pointer-events:none; transition:opacity .25s; z-index:40}
  .drawerOverlay.show{opacity:1; pointer-events:auto}
  .drawer{
    position:fixed; top:0; right:0; width:var(--cart-drawer-w);
    height:100dvh; background:#fff; box-shadow:-8px 0 24px rgba(0,0,0,.1);
    transform:translateX(100%); transition:transform .28s ease; z-index:41; display:flex; flex-direction:column;
    touch-action: pan-y;
  }
  .drawer.open{transform:translateX(0)}
  .drawer > header, .cartTotal{ touch-action: none; }
  .drawer header{display:flex; align-items:center; justify-content:space-between; padding:14px 16px; border-bottom:1px solid #eceff3; background:transparent; box-shadow:none}
  .drawer header h3{margin:0; font-size: clamp(18px, 3vmin, 22px); color:var(--ink)}
  .cartList{flex:1; min-height:0; overflow:auto; padding:12px}
  .cartItem{display:grid; grid-template-columns:56px 1fr auto; gap:10px; align-items:center; padding:8px 0; border-bottom:1px solid #f0f2f6; touch-action:pan-y; transition: transform .18s ease, opacity .18s ease}
  .cartItem img{width:100%; height:56px; object-fit:cover; border-radius:10px}
  .ph--cart{width:56px; height:56px; border-radius:10px; background:#f3f6fb; display:flex; align-items:center; justify-content:center; color:var(--muted-ink); font-size:12px}
  .cartTitle{font-weight:700}
  .cartSub{color:var(--muted-ink); font-size:.9em}
  .cartQty{display:flex; align-items:center; gap:8px}
  .cartQty .btnIcon{width:28px; height:28px; font-size:16px}
  .priceCol{display:flex; flex-direction:column; align-items:flex-end; gap:6px}
  .btnGhost{width:28px; height:28px; border-radius:10px; border:1px solid #e3e8f1; background:transparent; color:#8a8f99; font-weight:800; cursor:pointer}
  .cartTotal{ position:sticky; bottom:0; background:#f7f9fc; padding:12px 16px max(12px, env(safe-area-inset-bottom)); border-top:1px solid #e6ebf2; }

  /* Toast */
  .toast{position:fixed; left:50%; bottom:26px; transform:translateX(-50%) translateY(20px); background:rgba(0,0,0,.85); color:#fff; padding:12px 16px; border-radius:12px; font-weight:700; opacity:0; transition:opacity .2s ease, transform .2s ease; z-index:50; pointer-events:none}
  .toast.show{opacity:1; transform:translateX(-50%) translateY(0)}

  /* WhatsApp FAB */
  /* FAB WhatsApp con safe-area (notch, curvas) */
.wa-fab-img{
  position: fixed;
  right:  max(var(--edge-pad), env(safe-area-inset-right) + var(--edge-pad));   /* solapa */
  bottom: max(var(--edge-pad), env(safe-area-inset-bottom) + var(--edge-pad));  /* solapa */
  display: block;
  z-index: 60;
  transition: transform .12s ease;
  transform-origin: bottom right;
}
.wa-fab-img.hidden{ display:none !important; }
.wa-fab-img svg{ width: var(--wa-size-desktop); height: auto; }

.wa-fab-img::after{
  content:"Contactenos"; position:absolute; right: calc(100% + 10px); bottom: 8px;
  background: rgba(0,0,0,.85); color:#fff; font-weight:700; font-size:13px;
  padding:8px 10px; border-radius:2px; white-space:nowrap;
  opacity:0; transform: translateY(6px); pointer-events:none;
  transition: opacity .15s ease, transform .15s ease;
}
.wa-fab-img:hover::after,
.wa-fab-img:focus-visible::after,
.wa-fab-img.is-pressing::after{ opacity:1; transform: translateY(0); }

/* Fallback iOS antiguo */
@supports (right: constant(safe-area-inset-right)) {
  .wa-fab-img{
    right:  max(var(--edge-pad), constant(safe-area-inset-right) + var(--edge-pad));
    bottom: calc(var(--edge-pad) - constant(safe-area-inset-bottom));
  }
}

@media (max-width:680px){
  .wa-fab-img svg{ width: var(--wa-size-mobile); }
}
  /* QUIPUS */
  .quipu{
    position: absolute;
    top: 0;
    left: var(--x, 50%);
    transform: translateY(-110%) scale(var(--scale,1));
    opacity: 0;
    will-change: transform, opacity, margin-left;
    animation:
      fall var(--dur, 9s) linear var(--delay, 0s) 1 both,
      drift var(--drift-dur, 3.5s) ease-in-out calc(var(--delay, 0s) + .2s) infinite alternate;
  }
  @keyframes fall{
    0%   { transform: translateY(-110%) scale(var(--scale,1)); opacity: 1; }
    5%   { opacity: 1; }
    100% { transform: translateY(calc(var(--H, 60vh) + 110%)) scale(var(--scale,1)); opacity: 1; }
  }
  @keyframes drift{
    0%   { margin-left: 0; }
    100% { margin-left: var(--drift, 20px); }
  }
  .quipu .cord{
    position: relative;
    width: var(--cordW, 3px);
    height: var(--len, 44vmin);
    margin: 0 auto;
    border-radius: 999px;
    background:
      linear-gradient(to bottom,
        color-mix(in oklab, var(--c, #b45309) 92%, white 8%),
        color-mix(in oklab, var(--c, #b45309) 70%, black 10%)
      );
    box-shadow: inset 0 2px 6px rgba(0,0,0,.08);
  }
  .quipu .tassel{
    position: absolute; left: 50%; bottom: -20px; transform: translateX(-50%);
    width: calc(var(--cordW, 6px) * 3); height: 26px; border-radius: 0 0 12px 12px;
    background:
      linear-gradient(to bottom,
        color-mix(in oklab, var(--c, #b45309) 92%, white 8%),
        color-mix(in oklab, var(--c, #b45309) 70%, black 10%)
      );
  }
  .quipu .knot{
    position: absolute; left: 50%; transform: translateX(-50%) rotate(var(--r, 6deg));
    width: var(--w, 22px); height: var(--h, 10px); border-radius: 999px;
    background:
      linear-gradient(to bottom,
        color-mix(in oklab, var(--kc, #ef476f) 92%, white 8%),
        color-mix(in oklab, var(--kc, #ef476f) 70%, black 10%)
      );
    border: 1px solid color-mix(in oklab, var(--kc, #ef476f), black 18%);
    box-shadow: 0 2px 5px rgba(0,0,0,.08);
  }

  @media (prefers-reduced-motion: reduce){
    #quipu-sky{ display:none !important; }
  }

  .suggest{
    position: absolute;        /* antes: fixed */
    left: 0;
    right: 0;                  /* ocupa el ancho del buscador */
    top: calc(100% + 6px);     /* justo debajo del input */
    background: #fff;
    border: 1px solid #e6ebf2;
    border-radius: 12px;
    box-shadow: 0 8px 24px rgba(0,0,0,.08);
    max-height: 70vh;
    overflow: auto;
    z-index: 1000;             /* sobre el header */
  }
  .suggest[hidden]{ display:none; }
  .suggest-item{
      padding:10px 12px; font-weight:700; display:flex; justify-content:space-between; align-items:center; gap:10px; cursor:pointer;
  }
  .suggest-item small{ color:#8a8f99; font-weight:600; }
  .suggest-item:hover, .suggest-item.active{ background:#f7f9fc; }

  /* Botones del carrito ‚Äì estilo Kiosco Nelson */
  .btnWA{
    display:inline-flex; align-items:center; justify-content:center;
    padding:12px 14px; border-radius:12px; border:0; cursor:pointer;
    background:#25D366; color:#fff; font-weight:800;
    box-shadow: 0 4px 14px rgba(37,211,102,.35);
    transition: transform .12s ease, filter .12s ease, box-shadow .12s ease;
  }
  .btnWA:hover{
    filter:brightness(.98);
    box-shadow: 0 6px 18px rgba(37,211,102,.45);
    transform: translateY(-1px);
  }
  .btnWA:active{ transform: translateY(0); filter:brightness(.96); }
  .btnWA:disabled{ opacity:.6; cursor:not-allowed; }

  .btnClear{
    display:inline-flex; align-items:center; justify-content:center;
    padding:12px 14px; border-radius:12px; cursor:pointer;
    background:transparent; color:var(--ink);
    border:1px solid #e0e6ef; font-weight:800;
    transition: background-color .12s ease, border-color .12s ease, transform .12s ease;
  }
  .btnClear:hover{ background:#f3f6fb; border-color:#d7deea; transform: translateY(-1px); }
  .btnClear:active{ transform: translateY(0); }
</style>
</head>
<body>

<!-- Sprite de √≠conos (inline SVG) -->
<svg width="0" height="0" style="position:absolute;left:-9999px;opacity:0" aria-hidden="true" focusable="false">
  <symbol id="icon-offer" viewBox="0 0 24 24">
    <path d="M3 12l7.5 7.5a2 2 0 0 0 2.8 0L21 12l-7.7-7.7a2 2 0 0 0-2.8 0L3 12Z" fill="currentColor"/>
    <circle cx="12" cy="12" r="2.5" fill="#fff"/>
  </symbol>
  <symbol id="icon-cart" viewBox="0 0 24 24">
    <path d="M7 6h14l-1.6 8.1a2 2 0 0 1-2 1.6H9.2a2 2 0 0 1-2-1.6L5.5 3H2" stroke="currentColor" stroke-width="1.6" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
    <circle cx="9" cy="20" r="1.6" fill="currentColor"/><circle cx="18" cy="20" r="1.6" fill="currentColor"/>
  </symbol>
  <symbol id="icon-wa" viewBox="0 0 32 32">
    <path d="M27.1 4.9A14 14 0 0 0 5 26.8L3 31l4.4-1.9A14 14 0 1 0 27.1 4.9Z" fill="#25D366"/>
    <path d="M16 6.7a9.3 9.3 0 0 0-8 13.9l-.5 3 3.1-1.3a9.3 9.3 0 1 0 5.4-15.6Z" fill="#fff" opacity=".2"/>
    <path d="M22.3 19.1c-.1.4-.6.7-1 1-1.2.8-2.4.8-4.2.2-2.1-.7-4.7-2.9-5.5-5-.3-.7-.5-1.5-.2-2.3.2-.5.4-.9.8-1.2.2-.2.5-.3.7-.3.2 0 .4 0 .6.5.3.7.9 2.5.9 2.7.1.2 0 .5-.1.7-.2.3-.5.7-.7.9-.1.1-.2.2-.1.4.1.2.5 1 1.4 1.7 1 .8 1.8 1 2 .9.2-.1.5-.6.7-.9.2-.3.5-.4.8-.3.3.1 2 .9 2.3 1 .3.2.5.3.6.4.1.1.1.4 0 .6Z" fill="#fff"/>
  </symbol>
</svg>

<!-- Splash -->
<div id="splash" aria-hidden="true">
  <div class="splash-logo">
    <img id="splashLogo" alt="chasqui.ar" decoding="async" fetchpriority="high" />
  </div>
  <div class="splash-video">
    <video id="introVideo" playsinline muted autoplay preload="auto" webkit-playsinline disablepictureinpicture controlslist="nodownload noplaybackrate"></video>
  </div>
  <div class="loader" aria-hidden="true"></div>
</div>
<noscript><style>#splash{display:none !important}</style></noscript>

<!-- Header -->
<header id="siteHeader">
  <div class="wrap headerBar">
    <div class="logoWrap pressable" id="logoHome"><img id="headerLogo" src="logo-chasqui.png" alt="Logo" /></div>

    <label class="search" aria-label="Buscar productos">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M21 21l-4.3-4.3" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/><circle cx="11" cy="11" r="7" stroke="currentColor" stroke-width="1.6"/></svg>
      <input id="q" placeholder="Buscar‚Ä¶ (Enter)" autocomplete="off" />
      <ul id="suggest" class="suggest" hidden></ul>
    </label>

    <div class="iconBlock offers">
      <button id="offerBtn" class="iconBtn pressable" aria-label="Ofertas" title="Ofertas">
        <svg width="28" height="28" aria-hidden="true"><use href="#icon-offer"/></svg>
        <span id="offerBadge" class="badge" style="display:none">0</span>
      </button>
      <div class="iconLabel">Ofertas</div>
    </div>

    <div class="iconBlock cart">
      <button id="cartBtn" class="iconBtn pressable" aria-label="Carrito" title="Carrito">
        <svg width="28" height="28" aria-hidden="true"><use href="#icon-cart"/></svg>
        <span id="cartBadge" class="badge" style="display:none">0</span>
      </button>
      <div class="iconLabel">Mi carrito</div>
    </div>
  </div>
</header>

<!-- Capa de Quipus (full-width, bajo header) -->
<div id="quipu-sky" aria-hidden="true"></div>

<!-- Contenido -->
<main class="wrap">
  <div id="view">
    <div id="home" class="page active" style="position:absolute;inset:0;">
      <div class="homeGrid" id="homeGrid"></div>
    </div>
  </div>
</main>

<!-- Drawer Carrito -->
<div id="drawerOverlay" class="drawerOverlay"></div>
<aside id="cartDrawer" class="drawer" data-count="0" data-scale="md">
  <header>
    <h3>Tu carrito</h3>
    <button id="cartClose" class="btnIcon" aria-label="Cerrar">‚úï</button>
  </header>
  <div id="cartList" class="cartList"></div>
  <div class="cartTotal">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <strong>Total</strong><strong id="cartSum">$ 0</strong>
    </div>
    <div class="cartFooter">
      <button id="btnClear" class="btnClear">Vaciar</button>
      <button id="btnWA" class="btnWA">Pedir por WhatsApp</button>
    </div>
  </div>
</aside>

<!-- Toast -->
<div id="toast" class="toast" role="status" aria-live="polite">Agregado al carrito</div>

<!-- WhatsApp FAB -->
<a id="waFabImg" class="wa-fab-img pressable" target="_blank" rel="noopener" aria-label="WhatsApp" href="https://wa.me/5491151317667">
  <svg viewBox="0 0 32 32" aria-hidden="true"><use href="#icon-wa"/></svg>
</a>



<script>
/************ CONFIG ************/
const LOGO_SRC          = 'logo-chasqui.png';
const INTRO_VIDEO_SRC   = 'intro.mp4';
const LOGO_PERCENT      = 40;     // % lado menor (vmin)
const VIDEO_PERCENT     = 25;     // % lado menor (vmin)
const INTRO_MS          = 2000;   // duraci√≥n splash en ms

/* Cat√°logo demo */
let CATALOG = null;
const FALLBACK = [
  {"id":1,"nombre":"Cerveza Quilmes Lata 473ml","marca":"Quilmes","precio":1900,"unidad":"lata","categoria":"Alcohol","imagen":""},
  {"id":2,"nombre":"Fernet Branca 750ml","marca":"Branca","precio":9400,"unidad":"botella","categoria":"Alcohol","imagen":""},
  {"id":3,"nombre":"Marlboro Box","marca":"Marlboro","precio":5900,"unidad":"atado","categoria":"Cigarrillos","imagen":""},
  {"id":4,"nombre":"Coca-Cola 1.5L","marca":"Coca-Cola","precio":2800,"unidad":"botella","categoria":"Bebidas","imagen":""},
  {"id":6,"nombre":"Empanada","marca":"Casera","precio":1500,"unidad":"unidad","categoria":"Comida","imagen":""},
  {"id":7,"nombre":"Papas Lays 110g","marca":"Lays","precio":2300,"unidad":"paquete","categoria":"Snacks","imagen":""},
  {"id":8,"nombre":"Chocolate Milka 100g","marca":"Milka","precio":2400,"unidad":"tableta","categoria":"Dulces","imagen":""},
  {"id":9,"nombre":"Cable USB-C 1m","marca":"Gen√©rico","precio":3200,"unidad":"unidad","categoria":"Accesorios","imagen":""},
  {"id":10,"nombre":"Combo Gaseosa + Snacks","marca":"Promo","precio":3500,"unidad":"combo","categoria":"Ofertas","imagen":""}
];
const TILE_BG = {}; // ya no usamos im√°genes en las cajas

/************ SPLASH ************/
function wait(ms){ return new Promise(r=>setTimeout(r, ms)); }
async function runSplash(){
  document.documentElement.style.setProperty('--logoSize',  LOGO_PERCENT + 'vmin');
  document.documentElement.style.setProperty('--videoSize', VIDEO_PERCENT + 'vmin');
  document.documentElement.style.setProperty('--loaderMs',  (INTRO_MS/1000) + 's');

  splashLogo.src = LOGO_SRC;
  const video = document.getElementById('introVideo');
  video.src = INTRO_VIDEO_SRC;
  try { video.muted = true; } catch {}
  const tryPlay = () => video.play().catch(()=>{});
  if (video.readyState >= 1) { tryPlay(); }
  else {
    video.addEventListener('loadedmetadata', tryPlay, {once:true});
    setTimeout(tryPlay, 1500);
  }

  const decoded = splashLogo.decode ? splashLogo.decode().catch(()=>{}) : Promise.resolve();
  const docReady = (document.readyState === 'complete')
    ? Promise.resolve()
    : new Promise(res=> window.addEventListener('load', res, {once:true}));

  await Promise.all([decoded, docReady, wait(INTRO_MS)]);
  splash.classList.add('is-hidden');
  try { video.pause(); } catch {}
  splash.addEventListener('transitionend', ()=> {
    splash.remove();
    if (topIsHome()) startQuipuCycle();
  }, {once:true});
}

/************ ICON INTERACTION HELPERS ************/
function makePressable(el){
  if(!el) return;
  el.addEventListener('pointerdown', ()=> el.classList.add('is-pressing'), {passive:true});
  const clear=()=> el.classList.remove('is-pressing');
  el.addEventListener('pointerup', clear, {passive:true});
  el.addEventListener('pointercancel', clear, {passive:true});
  el.addEventListener('pointerleave', clear, {passive:true});
}

/************ CATALOGO ************/
async function getCatalog(){
  if (CATALOG) return CATALOG;
  try{
    const r = await fetch('productos.json?v=4',{cache:'no-store'});
    if(!r.ok) throw 0;
    const data = await r.json();
    if(!Array.isArray(data)) throw 0;
    CATALOG = data;
  }catch{ CATALOG = FALLBACK; }
  updateOfferBadge();
  return CATALOG;
}
const fmt = n => new Intl.NumberFormat('es-AR',{maximumFractionDigits:0}).format(Number(n)||0);

/************ HOME TILES (botones blancos) ************/
(function renderHome(){
  const tiles = [
    {slug:'alcohol-cigarros', label:'Alcohol y Cigarros', cats:['Alcohol','Cigarrillos']},
    {slug:'almacen',          label:'Almac√©n',           cats:['Almacen']},
    {slug:'bebidas',          label:'Bebidas',           cats:['Bebidas']},
    {slug:'comida',           label:'Comida',            cats:['Comida']},
    {slug:'snacks-dulces',    label:'Snacks y Dulces',   cats:['Snacks','Dulces']},
    {slug:'accesorios',       label:'Accesorios',        cats:['Accesorios']}
  ];
  homeGrid.innerHTML = '';
  tiles.forEach(t=>{
    const a = document.createElement('a');
    a.className = 'tile pressable';
    a.innerHTML = `<div class="tile__label">${t.label}<small>Ver productos</small></div>`;
    a.addEventListener('click', ()=> openCategoryGroup(t.label, t.slug, t.cats));
    makePressable(a);
    homeGrid.appendChild(a);
  });
})();

/************ NAV + LAYERS ************/
const view   = document.getElementById('view');
const drawer = document.getElementById('cartDrawer');
const overlay= document.getElementById('drawerOverlay');
const header = document.getElementById('siteHeader');

function topIsHome(){ const p = Array.from(view.querySelectorAll('.page')); return p.length && p.at(-1).id==='home'; }
function drawerOpen(){ return drawer.classList.contains('open'); }
function updateFabVisibility(){ const hide = drawerOpen() || !topIsHome(); waFabImg.classList.toggle('hidden', hide); }

/* Ajusta top de quipus (full width) a la altura real del header */
function updateSkyTop(){
  const h = header.getBoundingClientRect().height;
  document.getElementById('quipu-sky').style.setProperty('--sky-top', `${Math.round(h)}px`);
}
window.addEventListener('resize', updateSkyTop);
window.addEventListener('load', updateSkyTop);
updateSkyTop();

/* Scroll record */
let homeScrollY = 0;
const getScrollTop = () => (document.scrollingElement || document.documentElement).scrollTop;
function setScrollTop(y){
  const sc=document.scrollingElement||document.documentElement;
  sc.scrollTop=y; requestAnimationFrame(()=>sc.scrollTop=y); setTimeout(()=>sc.scrollTop=y,50);
}
function scrollToTopHard(){
  const sc=document.scrollingElement||document.documentElement;
  if(document.activeElement?.blur) document.activeElement.blur();
  sc.scrollTop=0; requestAnimationFrame(()=>sc.scrollTop=0); setTimeout(()=>sc.scrollTop=0,50);
}

/* Historial */
function pushStateSafe(state){ try{ history.pushState(state, ""); }catch{} }
function replaceHomeState(){ try{ history.replaceState({home:true}, ""); }catch{} }
window.addEventListener('popstate', ()=>{
  if (drawerOpen()){ closeCartDrawer(true); return; }
  if (!topIsHome()){ goHome(); return; }
});

/************ QUIPUS (continuo sin parpadeos) ************/
let QUIPUS_HOME          = 20;
const DUR_RANGE_HOME     = [4, 10];
const DELAY_MAX_HOME     = 0.4;
const DRIFT_PX_RANGE     = [20, 30];
const SCALE_RANGE_HOME   = [0.8, 1.2];
const KNOTS_RANGE_HOME   = [2, 6];
const CORDW_RANGE_HOME   = [6, 8];
const PALETTE = ["#ff006e","#ffd166","#06d6a0","#00d6ff","#3a86ff","#8338ec","#fb5607"];

const rand  = (a, b) => a + Math.random() * (b - a);
const irand = (a, b) => Math.round(rand(a, b));
const pick  = arr => arr[(Math.random() * arr.length) | 0];
const clamp = (n, a, b) => Math.max(a, Math.min(b, n));

function quipuMake(){
  const q = document.createElement('div'); q.className = 'quipu';
  const cord = document.createElement('div'); cord.className = 'cord';
  const tassel = document.createElement('div'); tassel.className = 'tassel';
  q.appendChild(cord); q.appendChild(tassel);
  quipuRandomize(q);        // define X, tama√±o, colores, etc. SOLO al nacer
  // Cuando termina la ca√≠da ‚Üí crear otro y quitar este (sin limpiar todo el cielo)
  q.addEventListener('animationend', (e)=>{
    if(e.animationName === 'fall') recycleQuipu(q);
  });
  return q;
}

function quipuRandomize(q){
  const sky = document.getElementById('quipu-sky');
  const headerH = document.getElementById('siteHeader').getBoundingClientRect().height;
  const H = sky.clientHeight || (innerHeight - headerH) || 400;
  sky.style.setProperty('--H', H + 'px');

  // Posici√≥n horizontal aleatoria SOLO al crear el quipu
  const x = rand(0, 100).toFixed(2) + '%';
  const scale = rand(SCALE_RANGE_HOME[0], SCALE_RANGE_HOME[1]).toFixed(2);
  const dur   = rand(DUR_RANGE_HOME[0], DUR_RANGE_HOME[1]).toFixed(2) + 's';
  const delay = rand(0, DELAY_MAX_HOME).toFixed(2) + 's';
  const drift = (Math.random() < 0.5 ? -1 : 1) * rand(DRIFT_PX_RANGE[0], DRIFT_PX_RANGE[1]);
  const driftDur = rand(2.4, 4.6).toFixed(2) + 's';
  const cordW = irand(CORDW_RANGE_HOME[0], CORDW_RANGE_HOME[1]) + 'px';
  const maxLen = Math.max(45, H - 5);
  const lenPx  = irand(Math.min(0.25 * H, 120), maxLen);
  const color  = pick(PALETTE);

  q.style.setProperty('--x', x);
  q.style.setProperty('--scale', scale);
  q.style.setProperty('--dur', dur);
  q.style.setProperty('--delay', delay);
  q.style.setProperty('--drift', drift.toFixed(1) + 'px');
  q.style.setProperty('--drift-dur', driftDur);
  q.style.setProperty('--cordW', cordW);
  q.style.setProperty('--len', lenPx + 'px');
  q.style.setProperty('--c', color);

  const cord = q.querySelector('.cord');
  cord.querySelectorAll('.knot').forEach(k => k.remove());
  const knots = irand(KNOTS_RANGE_HOME[0], KNOTS_RANGE_HOME[1]);
  for(let i=0;i<knots;i++){
    const k = document.createElement('div');
    k.className = 'knot';
    const topPct = clamp(rand(12, 88), 8, 92).toFixed(1) + '%';
    const w = irand(18, 30) + 'px';
    const h = irand(8, 14) + 'px';
    const rot = (rand(-10, 12)).toFixed(1) + 'deg';
    const kc = pick(PALETTE);
    k.style.top = topPct;
    k.style.setProperty('--w', w);
    k.style.setProperty('--h', h);
    k.style.setProperty('--r', rot);
    k.style.setProperty('--kc', kc);
    cord.appendChild(k);
  }
}

function recycleQuipu(oldQ){
  const sky = document.getElementById('quipu-sky');
  if(!sky || !quipuOn) return;
  // Crear primero el nuevo (para no generar ‚Äúhuecos‚Äù visuales)
  const q2 = quipuMake();
  sky.appendChild(q2);
  oldQ.remove();
}

function clearQuipus(){
  const sky = document.getElementById('quipu-sky');
  if (sky) sky.innerHTML = '';
}

function initialSpawn(n){
  const sky = document.getElementById('quipu-sky');
  if(!sky) return;
  sky.innerHTML = '';                   // limpiar solo al arrancar ciclo
  for(let i=0;i<n;i++){ sky.appendChild(quipuMake()); }
}

function ensureDensity(){
  const sky = document.getElementById('quipu-sky');
  if(!sky) return;
  const want = getTargetDensity();
  const cur  = sky.childElementCount;
  if(cur < want){
    for(let i=0;i<want-cur;i++){ sky.appendChild(quipuMake()); }
  }else if(cur > want){
    for(let i=0;i<cur-want;i++){ if(sky.lastElementChild) sky.removeChild(sky.lastElementChild); }
  }
}

let quipuOn = false;
function getTargetDensity(){
  const w = window.innerWidth;
  return w < 480 ? Math.ceil(24 * 0.6) :
         w < 820 ? Math.ceil(24 * 0.8) : 24;
}
function startQuipuCycle(){
  if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) return;
  if (quipuOn) return;
  quipuOn = true;
  initialSpawn(getTargetDensity());
}
function stopQuipuCycle(){
  quipuOn = false;
  clearQuipus();
}
window.addEventListener('resize', ()=>{ if(quipuOn) ensureDensity(); });


/************ NAVEGACI√ìN (con animaci√≥n) ************/
function pushPage(el){
  const stack = Array.from(view.querySelectorAll('.page'));
  const top = stack.at(-1);
  if(top && top.id === 'home'){ homeScrollY = getScrollTop(); }
  stack.forEach(p => p.classList.remove('active'));

  el.classList.add('page');
  view.appendChild(el);

  scrollToTopHard();
  requestAnimationFrame(()=> el.classList.add('active'));
  attachSwipeBack(el);
  updateFabVisibility();

  stopQuipuCycle(); // salimos de home
  pushStateSafe({page:true});
}
function popTop(){
  const pages = Array.from(view.querySelectorAll('.page'));
  const top = pages.at(-1); if(!top || top.id==='home') return;
  setScrollTop(homeScrollY);
  top.classList.remove('active'); top.classList.add('exit-right');
  top.addEventListener('transitionend', ()=>{
    top.remove();
    const home = document.getElementById('home');
    home.classList.add('active');
    updateFabVisibility();
    startQuipuCycle();
  }, {once:true});
}
function goHome(){
  Array.from(view.querySelectorAll('.page')).forEach(p=>{ if(p.id!=='home') p.remove(); });
  document.getElementById('home').classList.add('active');
  setScrollTop(homeScrollY);
  updateFabVisibility();
  startQuipuCycle();
}

/* Swipe back */
function attachSwipeBack(page){
  let sx=0, sy=0, tracking=false, dragging=false, pid=null;
  function isInteractiveStart(e){
    return !!e.target.closest('button, a, input, select, textarea, .btnPrimary, .btnIcon, .backBtn, label');
  }
  const onDown = (e)=>{
    if(isInteractiveStart(e)) return;
    tracking=true; dragging=false; sx=e.clientX; sy=e.clientY;
    pid=e.pointerId; page.setPointerCapture?.(pid); page.style.willChange='transform';
  };
  const onMove = (e)=>{
    if(!tracking) return;
    const dx=e.clientX-sx, dy=Math.abs(e.clientY-sy);
    if(dx>0 && dy<80){ dragging=true; page.style.transition='none'; page.style.transform=`translateX(${dx}px)`; e.preventDefault?.(); }
  };
  const onUp = (e)=>{
    if(!tracking) return; tracking=false;
    const dx=e.clientX-sx, dy=Math.abs(e.clientY-sy);
    page.releasePointerCapture?.(pid); page.style.transition='';
    if(dragging && dx>100 && dy<80){
      setScrollTop(homeScrollY);
      page.style.transform='translateX(100%)';
      page.addEventListener('transitionend', ()=>{
        page.remove(); document.getElementById('home').classList.add('active'); updateFabVisibility(); startQuipuCycle();
      }, {once:true});
    }else{
      page.style.transform='translateX(0)';
    }
    page.style.willChange='';
  };
  page.addEventListener('pointerdown', onDown, {passive:false});
  page.addEventListener('pointermove', onMove, {passive:false});
  page.addEventListener('pointerup',   onUp,   {passive:false});
  page.addEventListener('pointercancel', onUp, {passive:false});
}

/************ CATEGOR√çAS / OFERTAS ************/
async function openCategoryGroup(label, slug, cats){
  const list = (await getCatalog()).filter(p=> cats.includes(p.categoria));
  const page = document.createElement('div');
  page.id = `cat-${slug}`;
  page.innerHTML = `<div class="titleBar"><h2>${label}</h2><a id="back-${slug}" class="backBtn pressable" href="#">‚Üê Inicio</a></div><div class="grid" id="grid-${slug}"></div>`;
  pushPage(page);
  makePressable(page.querySelector(`#back-${slug}`));
  page.querySelector(`#back-${slug}`).addEventListener('click', (e)=>{ e.preventDefault(); goHome(); });
  const grid = page.querySelector(`#grid-${slug}`);
  if(list.length===0){ grid.innerHTML = `<div style="grid-column:1/-1;opacity:.8">Sin productos.</div>`; return; }
  list.forEach(p=> grid.appendChild(productCard(p)));
}

offerBtn.addEventListener('click', ()=>{
  const top = Array.from(view.querySelectorAll('.page')).at(-1);
  if(top && top.id==='cat-ofertas'){ history.back(); return; }
  openOffers();
});

async function openOffers(){
  const list = (await getCatalog()).filter(p=> p.categoria==='Ofertas');
  const page = document.createElement('div');
  page.id = `cat-ofertas`;
  page.innerHTML = `<div class="titleBar"><h2>Ofertas</h2><a id="back-ofertas" class="backBtn pressable" href="#">‚Üê Inicio</a></div><div class="grid" id="grid-ofertas"></div>`;
  pushPage(page);
  makePressable(page.querySelector('#back-ofertas'));
  page.querySelector('#back-ofertas').addEventListener('click', (e)=>{ e.preventDefault(); goHome(); });
  const grid = page.querySelector('#grid-ofertas');
  if(list.length===0){ grid.innerHTML = `<div style="grid-column:1/-1;opacity:.8">Sin ofertas por ahora.</div>`; return; }
  list.forEach(p=> grid.appendChild(productCard(p)));
}

async function updateOfferBadge(){ const count = (await getCatalog()).filter(p=> p.categoria==='Ofertas').length; offerBadge.textContent = count; offerBadge.style.display = count>0 ? 'inline-flex' : 'none'; }

/************ PRODUCT CARD ************/
function productCard(p){
  const precio = fmt(p.precio);
  const card = document.createElement('article');
  card.className = 'card';
  const imgTag = p.imagen
    ? `<img src="${p.imagen}" alt="${p.nombre}" onerror="this.parentElement.textContent='Sin imagen';">`
    : 'Sin imagen';
  card.innerHTML = `
    <div class="ph">${imgTag}</div>
    <div class="info"><div class="title">${p.nombre}</div><div class="meta"><span>${p.marca}</span><span class="price">$ ${precio}</span></div></div>
    <div class="qtyRow">
      <div class="qtyCtrl">
        <button class="btnIcon pressable" data-act="minus">‚àí</button>
        <strong class="qty" aria-live="polite">1</strong>
        <button class="btnIcon pressable" data-act="plus">+</button>
      </div>
      <button class="btnPrimary pressable" data-act="add">Agregar</button>
    </div>
  `;
  card.querySelectorAll('.pressable').forEach(makePressable);

  let qty=1; const qtyEl=card.querySelector('.qty');
  card.addEventListener('click',(e)=>{
    const act=e.target.getAttribute('data-act'); if(!act) return;
    if(act==='minus'){ qty=Math.max(1,qty-1); qtyEl.textContent=qty; }
    if(act==='plus'){ qty=Math.min(99,qty+1); qtyEl.textContent=qty; }
    if(act==='add'){ addToCart(p,qty); }
  });
  return card;
}

/************ CARRITO ************/
const cartList = document.getElementById('cartList');
const cartSum  = document.getElementById('cartSum');
const cartBadge= document.getElementById('cartBadge');
const cartClose= document.getElementById('cartClose');
const btnWA    = document.getElementById('btnWA');
const btnClear = document.getElementById('btnClear');
const toast    = document.getElementById('toast');

function openCartDrawer(){
  if(drawerOpen()) return;
  overlay.classList.add('show');
  drawer.classList.add('open');
  updateFabVisibility();
  pushStateSafe({drawer:true});
}
function closeCartDrawer(byPop=false){
  overlay.classList.remove('show');
  drawer.classList.remove('open');
  drawer.style.transform = '';
  updateFabVisibility();
  if(!byPop){ try{ history.back(); }catch{} }
}
overlay.addEventListener('click', ()=> closeCartDrawer(false));
cartClose.addEventListener('click', ()=> closeCartDrawer(false));
cartBtn.addEventListener('click', openCartDrawer);
btnClear.addEventListener('click', ()=>{ cart.clear(); renderCart(); });

const cart = new Map();
function showToast(msg='Agregado al carrito'){ toast.textContent=msg; toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'),1500); }
function addToCart(p, qty){
  const prev = cart.get(p.id)?.qty || 0;
  cart.set(p.id, {p, qty: prev + qty});
  renderCart(); showToast();
}
function renderCart(){
  cartList.innerHTML=''; let total=0;
  cart.forEach(({p,qty})=>{
    const line=p.precio*qty; total+=line;
    const row=document.createElement('div');
    row.className='cartItem';
    row.innerHTML = `${p.imagen?`<img src="${p.imagen}" alt="">`:`<div class="ph--cart">Sin imagen</div>`}
      <div>
        <div class="cartTitle">${p.nombre}</div>
        <div class="cartSub">${p.marca} ¬∑ $ ${fmt(p.precio)} c/u</div>
        <div class="cartQty">
          <button class="btnIcon pressable" data-id="${p.id}" data-act="dec">‚àí</button>
          <strong>${qty}</strong>
          <button class="btnIcon pressable" data-id="${p.id}" data-act="inc">+</button>
        </div>
      </div>
      <div class="priceCol">
        <div style="font-weight:800">$ ${fmt(line)}</div>
        <button class="btnGhost pressable" title="Quitar" data-id="${p.id}" data-act="del">√ó</button>
      </div>`;
    cartList.appendChild(row);
    row.querySelectorAll('.pressable').forEach(makePressable);
    attachSwipeDelete(row, p.id);
  });
  const nItems=cart.size; drawer.dataset.count=String(nItems);
  drawer.dataset.scale = nItems>=8 ? 'xxs' : nItems>=5 ? 'xs' : 'md';
  const totalQty=[...cart.values()].reduce((s,{qty})=>s+qty,0);
  cartSum.textContent=`$ ${fmt(total)}`;
  cartBadge.style.display=totalQty>0?'inline-flex':'none';
  cartBadge.textContent=totalQty;
  btnWA.style.display=totalQty>0?'inline-flex':'none';
}
function attachSwipeDelete(row, id){
  let sx=0, sy=0, tracking=false, dragging=false, pid=null;
  const onDown = e=>{ tracking=true; dragging=false; sx=e.clientX; sy=e.clientY; pid=e.pointerId; row.setPointerCapture?.(pid); row.style.willChange='transform'; };
  const onMove = e=>{
    if(!tracking) return;
    const dx=e.clientX-sx, dy=Math.abs(e.clientY-sy);
    if(dx<0 && dy<80){
      dragging=true; row.style.transform=`translateX(${dx}px)`; row.style.opacity = String(Math.max(0.3, 1 + dx/220)); e.preventDefault?.();
    }
  };
  const onUp = e=>{
    if(!tracking) return; tracking=false;
    row.releasePointerCapture?.(pid);
    const dx=e.clientX-sx, dy=Math.abs(e.clientY-sy);
    if(dragging && dx<-100 && dy<80){ cart.delete(id); renderCart(); }
    else{ row.style.transform='translateX(0)'; row.style.opacity='1'; }
    row.style.willChange='';
  };
  row.addEventListener('pointerdown', onDown, {passive:false});
  row.addEventListener('pointermove', onMove, {passive:false});
  row.addEventListener('pointerup',   onUp,   {passive:false});
  row.addEventListener('pointercancel', onUp, {passive:false});
}
cartList.addEventListener('click',(e)=>{
  const act=e.target.getAttribute('data-act'); if(!act) return;
  const id=Number(e.target.getAttribute('data-id')); const item=cart.get(id);
  if(act==='inc' && item){ item.qty=Math.min(99,item.qty+1); }
  if(act==='dec' && item){ item.qty=Math.max(0,item.qty-1); if(item.qty===0) cart.delete(id); }
  if(act==='del'){ cart.delete(id); }
  renderCart();
});
btnWA.addEventListener('click',()=>{
  if(cart.size===0) return;
  let lines=['üßæ *Pedido chasqui.ar*']; let total=0;
  cart.forEach(({p,qty})=>{ const line=p.precio*qty; total+=line; lines.push(`‚Ä¢ ${qty} x ${p.nombre} (${p.marca}) ‚Äî $ ${fmt(p.precio)} = $ ${fmt(line)}`); });
  lines.push('‚Äî'.repeat(24), `*TOTAL:* $ ${fmt(total)}`);
  window.open(`https://wa.me/5491151317667?text=${encodeURIComponent(lines.join('\n'))}`,'_blank');
});

/* Drawer swipe close */
function enableCartSwipeClose(){
  let startX=0, startY=0, dragging=false, captured=false, pid=null;
  function canStartDrawerSwipe(e){
    if(!drawer.classList.contains('open')) return false;
    if(cart.size === 0) return true;
    const t = e.target;
    if (t.closest('#cartClose, #btnWA, #btnClear, button, a')) return false;
    if (t.closest('.cartItem')) return false;
    if (t.closest('.drawer > header')) return true;
    if (t.closest('.cartTotal')) return true;
    if (t.closest('.cartList')) return true;
    return true;
  }
  const onDown = (e)=>{ if(!canStartDrawerSwipe(e)) return; dragging = true; captured = false; startX = e.clientX; startY = e.clientY; };
  const onMove = (e)=>{
    if(!dragging) return;
    const dx = e.clientX - startX;
    const dy = Math.abs(e.clientY - startY);
    if (!captured && dx > 10 && dy < 80){
      pid = e.pointerId;
      drawer.setPointerCapture?.(pid);
      drawer.style.willChange = 'transform';
      overlay.style.transition = 'none';
      captured = true;
    }
    if (captured && dx > 0 && dy < 80){
      drawer.style.transform = `translateX(${dx}px)`;
      const max = Math.min(window.innerWidth * 0.6, 400);
      overlay.style.opacity = String(Math.max(0, 1 - dx / max));
      e.preventDefault?.();
    }
  };
  const onUp = (e)=>{
    if(!dragging) return; dragging = false;
    if (captured){
      drawer.releasePointerCapture?.(pid);
      drawer.style.willChange = '';
      overlay.style.transition = '';
    }
    const dx = e.clientX - startX;
    const dy = Math.abs(e.clientY - startY);
    if (dx > 100 && dy < 80){ closeCartDrawer(true); overlay.style.opacity = ''; }
    else{ drawer.style.transform = ''; overlay.style.opacity = ''; }
  };
  drawer.addEventListener('pointerdown', onDown, {passive:false});
  drawer.addEventListener('pointermove', onMove, {passive:false});
  drawer.addEventListener('pointerup',   onUp,   {passive:false});
  drawer.addEventListener('pointercancel', onUp, {passive:false});
}

/************ SEARCH SUGGEST ************/
const inputQ   = document.getElementById('q');
const suggest  = document.getElementById('suggest');
let suggestItems = []; let suggestIndex = -1; let SUGGEST_POOL = null;

const CATEGORY_ALIASES = [
  {cats:['Alcohol'],      terms:['alcohol','alcoh','alc']},
  {cats:['Cigarrillos'],  terms:['cigarrillos','cigarros','cigarr','cig']},
  {cats:['Bebidas'],      terms:['bebidas','bebid','beb']},
  {cats:['Comida'],       terms:['comida','comid','comi']},
  {cats:['Almacen'],      terms:['almacen','almac√©n','alm']},
  {cats:['Snacks'],       terms:['snacks','snack','sna']},
  {cats:['Dulces'],       terms:['dulces','dulce','dulc']},
  {cats:['Snacks','Dulces'], terms:['snacks y dulces','snacks dulces','snacks y','dulces y']},
  {cats:['Alcohol','Cigarrillos'], terms:['alcohol y cigarr','alcohol y cigarros','alcohol y cigarrillos']}
];
function matchCategoryTerms(q){
  q = q.toLowerCase().trim();
  if(q.length < 3) return null;
  for(const a of CATEGORY_ALIASES){ if(a.terms.some(t=> q.includes(t))) return a.cats; }
  return null;
}
async function buildSuggestPool(){
  const cat = await getCatalog();
  const map = new Map();
  cat.forEach(p=>{
    const name = (p.nombre||'').trim();
    const brand= (p.marca||'').trim();
    if(!name) return;
    map.set(p.id, {texto:name, marca:brand, id:p.id});
  });
  return Array.from(map.values());
}

function renderSuggest(list){
  suggest.innerHTML = '';
  if(!list.length){ suggest.hidden = true; return; }
  const MAX = 30;
  list.slice(0, MAX).forEach((item, i)=>{
    const li = document.createElement('li');
    li.className = 'suggest-item' + (i===suggestIndex ? ' active':'');
    li.innerHTML = `<span>${item.texto}</span>${item.marca ? `<small>${item.marca}</small>`:''}`;
    li.addEventListener('mousedown', (e)=>{
      e.preventDefault();
      inputQ.value = item.texto;
      openSearchResults(item.texto);
      hideSuggest();
    });
    suggest.appendChild(li);
  });
  suggest.hidden = false;
  positionSuggest();
}
function hideSuggest(){ suggest.hidden = true; suggestIndex = -1; suggest.innerHTML = ''; }

inputQ.addEventListener('input', async ()=>{
  const q = inputQ.value.trim().toLowerCase();
  if(!q){ hideSuggest(); return; }
  if(!SUGGEST_POOL) SUGGEST_POOL = await buildSuggestPool();

  let catPart = [];
  const matchedCats = matchCategoryTerms(q);
  if(matchedCats){
    const prods = (await getCatalog()).filter(p=> matchedCats.includes(p.categoria));
    catPart = prods.map(p => ({texto: p.nombre, marca: p.marca||'', id:p.id}));
  }

  const starts = SUGGEST_POOL.filter(x =>
    x.texto.toLowerCase().startsWith(q) || (x.marca||'').toLowerCase().startsWith(q)
  );
  const startsSet = new Set(starts.map(x=>x.id));
  const contains = SUGGEST_POOL.filter(x =>
    !startsSet.has(x.id) && (x.texto.toLowerCase().includes(q) || (x.marca||'').toLowerCase().includes(q))
  );

  const seen = new Set();
  suggestItems = [];
  for(const block of [catPart, starts, contains]){
    for(const it of block){
      if(!seen.has(it.id)){ seen.add(it.id); suggestItems.push(it); }
    }
  }
  suggestIndex = -1; renderSuggest(suggestItems);
});

inputQ.addEventListener('keydown', (e)=>{
  if(suggest.hidden) return;
  if(e.key === 'ArrowDown'){ e.preventDefault(); suggestIndex = Math.min((suggestIndex+1), Math.min(29, suggestItems.length-1)); renderSuggest(suggestItems); }
  else if(e.key === 'ArrowUp'){ e.preventDefault(); suggestIndex = Math.max((suggestIndex-1), -1); renderSuggest(suggestItems); }
  else if(e.key === 'Enter'){
    if(suggestIndex >= 0){ e.preventDefault(); const sel = suggestItems[suggestIndex]; inputQ.value = sel.texto; openSearchResults(sel.texto); hideSuggest(); }
  }else if(e.key === 'Escape'){ hideSuggest(); }
});
document.addEventListener('pointerdown', (e)=>{
  if(!suggest.hidden && !suggest.contains(e.target) && e.target !== inputQ){ hideSuggest(); }
});

/************ SEARCH RESULTS ************/
async function openSearchResults(text){
  const q = String(text||'').trim().toLowerCase();
  const cats = matchCategoryTerms(q);
  const list = (await getCatalog()).filter(p=>{
    const nm = (`${p.nombre||''}`).toLowerCase();
    const br = (`${p.marca||''}`).toLowerCase();
    const inText = nm.includes(q) || br.includes(q);
    const inCat  = cats ? cats.includes(p.categoria) : false;
    return inText || inCat;
  });

  const page = document.createElement('div');
  page.id = `cat-search`;
  page.innerHTML = `<div class="titleBar"><h2>Resultados</h2><a id="back-search" class="backBtn pressable" href="#">‚Üê Inicio</a></div><div class="grid" id="grid-search"></div>`;
  pushPage(page);
  makePressable(page.querySelector('#back-search'));
  page.querySelector('#back-search').addEventListener('click',(e)=>{e.preventDefault(); goHome();});
  const grid = page.querySelector('#grid-search');
  if(list.length===0){ grid.innerHTML = `<div style="grid-column:1/-1;opacity:.8">Sin resultados.</div>`; return; }
  list.forEach(p=> grid.appendChild(productCard(p)));
}

/************ BOOT ************/
(function boot(){
  replaceHomeState();
  getCatalog();
  updateOfferBadge();
  updateFabVisibility();
  makePressable(waFabImg);
  enableCartSwipeClose();
  runSplash();
})();
</script>
</body>
</html>
